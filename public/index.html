<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>San Juan</title>
	<link rel="stylesheet" href="style.css" />
	<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400..900&display=swap" rel="stylesheet" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
	<link rel="icon" href="icon.png" />
</head>

<body>
	<div class="container">
		<img src="icon.png" class="overlay-image" />
		<video autoplay loop muted playsinline id="video-bg">
			<source src="video.mp4" type="video/mp4" />
			Tu navegador no soporta la etiqueta de video.
		</video>

		<div class="badge">Countdown Blocked</div>
		<i class="fas fa-lock lock-icon" id="lockIcon"></i>

		<div class="password-box" id="passwordBox">
			<input type="text" id="passwordInput" placeholder="ContraseÃ±a" />
			<button onclick="checkPassword()">Enter</button>
		</div>

		<div class="counter" id="counter">0</div>
	</div>

	<div class="tracklist" id="tracklist"></div>

	<script>
		let targetDate = new Date("3333-12-31T20:00:00");
		let unlocked = false;
		let attempts = 0;

		const hints = [
			"Es una artista que participa en el disco...",
			"Es andaluza...",
			"Con ella puedes sumergirte en La Charca..."
		];

		function renderTracklist(tracks) {
			const container = document.getElementById('tracklist');
			container.innerHTML = '';

			const col1 = document.createElement('div');
			col1.className = 'track-column';
			const col2 = document.createElement('div');
			col2.className = 'track-column';

			tracks.forEach(track => {
				const div = document.createElement('div');
				div.className = 'track';

				const number = document.createElement('span');
				number.className = 'track-number';
				number.textContent = `${track.number}.`;

				const name = document.createElement('span');
				name.className = track.blurred && !unlocked ? 'track-name blur' : 'track-name';
				name.textContent = track.blurred && !unlocked ? 'â€¢â€¢â€¢â€¢â€¢â€¢' : track.name;

				div.appendChild(number);
				div.appendChild(name);

				if (track.url && (!track.blurred || unlocked)) {
					const link = document.createElement('a');
					link.href = track.url;
					link.target = '_blank';
					link.className = 'listen-button';
					link.innerHTML = `<i class="fas fa-play"></i>`;
					div.appendChild(link);
				}

				(track.number <= 6 ? col1 : col2).appendChild(div);
			});

			container.appendChild(col1);
			container.appendChild(col2);
		}

		function updateCountdown() {
			if (!targetDate) return;

			const now = new Date();
			const diff = targetDate.getTime() - now.getTime();

			if (diff <= 0) {
				document.getElementById("counter").innerText = "";
				return;
			}

			const days = Math.floor(diff / (1000 * 60 * 60 * 24));
			const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
			const minutes = Math.floor((diff / (1000 * 60)) % 60);
			const seconds = Math.floor((diff / 1000) % 60);

			const countdownHTML = `${days}d ${hours}h ${minutes}m ${seconds}s`;
			document.getElementById("counter").innerHTML = `<span${unlocked ? '' : ' class="blurred"'}>${countdownHTML}</span>`;
		}

		setInterval(updateCountdown, 1000);
		updateCountdown();

		document.querySelector('#lockIcon').addEventListener('click', () => {
			document.getElementById('passwordBox').style.display = 'flex';
		});

		function showHint(text) {
			const hint = document.createElement('div');
			hint.className = 'hint';
			hint.innerText = text;
			document.body.appendChild(hint);
			setTimeout(() => hint.remove(), 2000);
		}

		async function checkPassword() {
			const input = document.getElementById('passwordInput').value;

			try {
				const response = await fetch('/check-password', {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ password: input })
				});

				if (response.ok) {
					unlocked = true;

					const dateRes = await fetch('/get-target-date');
					const dateData = await dateRes.json();
					targetDate = new Date(dateData.date);

					updateCountdown();
					document.getElementById('passwordBox').style.display = 'none';
					document.querySelector('.badge').style.display = 'none';
					document.getElementById('lockIcon').style.display = 'none';

					// Vuelve a cargar el tracklist ya desbloqueado
					loadTracklist();
				} else {
					if (attempts < hints.length) {
						showHint(hints[attempts]);
					} else {
						showHint("Demasiados intentos... ðŸ˜µ");
						setTimeout(() => {
							window.location.href = "https://www.youtube.com/watch?v=41CMObnPeSQ&t=23s";
						}, 2000);
					}
					attempts++;
				}
			} catch (err) {
				console.error('Error al verificar contraseÃ±a:', err);
				alert("Error de conexiÃ³n.");
			}
		}

		const API_KEY = process.env.API_KEY;


		function loadTracklist() {
			fetch('/tracklist', {
				headers: {
					'x-api-key': API_KEY
				}
			})
				.then(res => {
					if (!res.ok) throw new Error('No autorizado');
					return res.json();
				})
				.then(tracks => renderTracklist(tracks))
				.catch(err => {
					console.error('Error al cargar tracklist:', err);
				});
		}


		// Llamada inicial
		loadTracklist();
	</script>

</body>

</html>